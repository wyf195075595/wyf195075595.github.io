---
title:  vue 实践与优化
date: 2022-08-05 08:23:10
tags: 
categories: vuex
---



### 1、在使用 element UI 的 el-image 时，首次加载图片出现白色闪现效果

这是应为 组件内 在加载前和加载中是一个类名为el-image__placeholder的div标签，在加载后和加载出错后的处理分别是一个div和img标签。

解决方法：在加载前和加载后的样式上做更改，可以**重写覆盖**类名**el-image__placeholder**和**el-image__error**来自定义自己想要的效果了

```css
// 将默认的白色背景去除

::v-deep .el-image__placeholder,
::v-deep .el-image__error
{
    background: none !important;
}
```



### 2、vue 路由 tab切换时，动态判断左右切换过渡动画

> 预置三种动画
>
> 1. opacity-scale
> 2. switch-right
> 3. switch-left

```css
/**
    transition-动画 [透明缩放]
    name: "opacity-scale"
 */
.opacity-scale-enter-active {
    transition: all 0.65s ease;
}
.opacity-scale-leave-active {
    transition: all 0.65s ease;
}
.opacity-scale-enter {
    opacity: 0;
    transform: scale(0.9);
}
.opacity-scale-enter-to {
    opacity: 1;
    transform: scale(1);
}
.opacity-scale-leave {
    opacity: 1;
    transform: scale(1);
}
.opacity-scale-leave-to {
    opacity: 0;
    transform: scale(0.9);
}

/**
    transition-动画 [透明]
    name: "opacity-scale"
 */
 .opacity-enter-active {
    transition: all 0.65s ease;
}
.opacity-leave-active {
    transition: all 0.65s ease;
}
.opacity-enter {
    opacity: 0;
}
.opacity-enter-to {
    opacity: 1;
}
.opacity-leave {
    opacity: 1;
}
.opacity-leave-to {
    opacity: 0;
}

/**
    transition-动画 [幻灯片（从左向右）]
    name: "switch-left"
 */
.switch-left-enter-active {
    transition: all 0.85s ease;
}
.switch-left-leave-active {
    transition: all 0.85s ease;
}
.switch-left-enter {
    transform: translateX(-100%);
    opacity: .85;
}
.switch-left-enter-to {
    transform: translateX(0);
    opacity: 1;
}
.switch-left-leave {
    transform: translateX(0);
    opacity: 1;
}
.switch-left-leave-to {
    transform: translateX(100%);
    opacity: .85;
}

/**
    transition-动画 [幻灯片（从右向左）]
    name: "switch-right"
 */
.switch-right-enter-active {
    transition: all 0.85s ease;
}
.switch-right-leave-active {
    transition: all 0.85s ease;
}
.switch-right-enter {
    transform: translateX(100%);
    opacity: .85;
}
.switch-right-enter-to {
    transform: translateX(0);
    opacity: 1;
}
.switch-right-leave {
    transform: translateX(0);
    opacity: 1;
}
.switch-right-leave-to {
    transform: translateX(-100%);
    opacity: .85;
}

/**
    菜单下拉动画
 */
.menu-upbit-anim {
    animation-duration: .3s;
    animation-fill-mode: both;
    animation-name: menu-top-to-bottom;
}

@keyframes menu-top-to-bottom{
    from{
        opacity:.3;
        margin-top: -30px;
    }
    to{
        opacity:1;
        margin-top: 0;
    }
}
```

**设置路由**

通过设置路由属性 meta.sort 来记录路由位置

```js
const routers = [
	 {
    path: "/defectControl",
    name: "defectControl",
    meta: {
      keepAlive: false,
      sort: "c-1",
    },
    component: () =>
      import(
        /* webpackChunkName: "defectControl-index" */ "@/views/defectControl/index.vue"
      ),
    children: [
      {
        // 首页
        path: "frontPage",
        name: "defectControl-frontPage",
        meta: {
          keepAlive: false,
          sort: "c-2",
        },
        component: () =>
          import(
            /* webpackChunkName: "defectControl-frontPage" */ "@/views/defectControl/frontPage.vue"
          ),
      },
      {
        path: "defectPool",
        name: "defectControl-defectPool",
        meta: {
          keepAlive: false,
          sort: "c-3",
        },
        component: () =>
          import(
            /* webpackChunkName: "defectControl-defectPool" */ "@/views/defectControl/defectPool.vue"
          ),
      },
      {
        path: "defectCondition",
        name: "defectControl-defectCondition",
        meta: {
          keepAlive: false,
          sort: "c-4",
        },
        component: () =>
          import(
            /* webpackChunkName: "defectControl-defectCondition" */ "@/views/defectControl/defectCondition.vue"
          ),
      },
      {
        path: "defectFocal",
        name: "defectControl-defectFocal",
        meta: {
          keepAlive: false,
          sort: "c-5",
        },
        component: () =>
          import(
            /* webpackChunkName: "defectControl-defectFocal" */ "@/views/defectControl/defectFocal.vue"
          ),
      },
      {
        path: "defect",
        name: "defectControlConfiguration-defectConfig",
        meta: {
          keepAlive: false,
          sort: "c-6",
        },
        component: () =>
          import(
            /* webpackChunkName: "defectControlConfiguration-defectConfig" */ "@/views/defectControl/defectControlConfiguration/defectView.vue"
          ),
      },
    ],
  },
]
```

**监听路由变化**

```js
{
    data() {
        return {
            transitionName: "opacity-scale"
        }
    },
	watch: {
		$route(to, from) {
          // 查看路由元信息中是否设置了动画名
          if (to?.meta?.transitionName) {
            return (this.transitionName = to.meta.transitionName);
          }
          // 如果是主模块，不是子模块不需要动画
          if (from.path === "/defectControl") {
            return (this.transitionName = "none");
          }
          const toSort = to?.meta?.sort;
          const fromSort = from?.meta?.sort;
          // 未设置路由元信息位置，默认透明缩放效果
          if (!isString(toSort) || !isString(fromSort)) {
            return (this.transitionName = "opacity-scale");
          }
          // 比较路由位置判断左右切换的动画名称
          this.transitionName =
            toSort.localeCompare(fromSort) > 0 ? "switch-right" : "switch-left";
        },
	}
}
```



### 3、退出登录再登录提示路由重复问题

> 本质上就是路由重复注册导致的提示，我们可以在每次登出时，清除注册路由

在 router 文件中

```js
import Vue from 'vue'
import VueRouter from 'vue-router'

import BaseLayout from "@/layouts/BaseLayout.vue"
Vue.use(VueRouter)

export const constantRoutes = [
  {
    path: '/',
    redirect: '/login', // 重定向到 /home 路径
    component: BaseLayout,
    children: [
      {
        name: 'home',
        path: '/home', 
        component: () => import(/* webpackChunkName: "Home" */ '@/views/home/Home.vue')
      },
 
    ], 
  },
  {
    path: '/login',
    name: 'login',
    component: () => import(/* webpackChunkName: "login" */ '@/views/login/Login.vue')
  },

]

const router = new VueRouter({
  routes: constantRoutes
})

// 解决重复点击导航时，控制台出现报错
const VueRouterPush = VueRouter.prototype.push
VueRouter.prototype.push = function push (to) {
  return VueRouterPush.call(this, to).catch(err => err)
}
// 路由重置，解决退出登录后路由重复提示
const createRouter = () => new VueRouter({
  routes: constantRoutes,// 添加默认路由，找不到路由可能导致报错
})
export function resetRouter() {
  const newRouter = createRouter();
  router.matcher = newRouter.matcher;
}

export default router

```

退出登录时调用

```js
loginOut() {
    this.$store.dispatch('globalModule/FedLogOut').then(()=> {
        resetRouter();
        // 此处确保 login 路由存在
        this.$router.push({name: 'login'});
    })
},
```

> [参考链接](https://blog.csdn.net/shiningchen322/article/details/127958801)
>

### 4、用户在指定页面因token过期而导致返回登录页，登陆后回到此页面

需要在 axios 响应拦截时处理

```js
if(code == 401) {
    Vue.prototype.$message.error("登录状态已过期,请重新登录");
    store.dispatch('globalModule/LogOut').then(() => {
        // 此处路由到login并添加标记
        router.push(`/login?redirect=${store.getters.activeMenu}`)
    })
    return Promise.reject('无效的会话，或者会话已过期，请重新登录。')
}
```

在全局路由前置守卫合适的地方添加判断

```js
let redirect = new URLSearchParams(location.hash.slice(7)).get('redirect');
if(redirect) {
    location.hash = '';
    next({ path: redirect, replace: true })
} else {
    next()
}
```

